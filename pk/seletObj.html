<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="Semantic-UI-CSS-master/semantic.min.css">
<script src="https://www.gstatic.com/firebasejs/4.0.0/firebase.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
<script src="Semantic-UI-CSS-master/semantic.min.js"></script>
<script src="js/aframe.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<link rel="stylesheet" href="css/layout.css">
<script src="js/noneNblock.js"></script>

<body>
    <div id="lat" value=0></div>
    <div id="lon" value=0></div>
    <div id="deltaAlpha" value=0></div>

    <div id="arCam"></div>
    <div id="vrScene"></div>
    <div id="point"></div>
    <div id="putObjForm"></div>
    <div id="addFriForm"></div>
    <div id="addCouForm"></div>
    <button type="button" onclick='blockById("sendForm")' id="put">
        <img src="img/put.png">
    </button>

    <button type="button" onclick="_init_()" id="updata">
        <img src="img/updata.png">

        <button type="button" onclick="objCursorEvent()" id="pick">
            <img src="img/pick.png">
        </button>
</body>
<script src="js/getGPS.js"></script>
<script src="js/gcs2Gauss.js"></script>
<script src="js/arInit.js"></script>
<script src="js/fbInit.js"></script>


<script src="js/putObjForm.js" charset="UTF-8"></script>

<script>
    var deltaAlpharam = 0;
    var dataArrayy = [];//多一個y
    var datax = [];
    var datay = [];
    var couponArray = [];
    var couponx= [];
    var coupony =[];
    var adArray = [];//new
    var adx=[];
    var ady=[];
    var _init_ = () => {
        datax = [];
        datay = [];
        couponx= []
        coupony= []
        adx=[];
        ady=[];
        var deltaAlpha = document.getElementById("deltaAlpha").value;
        deltaAlpharam = deltaAlpha;
        setCamera("camera", deltaAlpharam);
        deletDataArray(dataArrayy);
        deletCursorArray(couponArray);
        deletAdArray(adArray);
        updataObj().then(() => {
            arrayCreateObj(dataArrayy);
        });
        updataCoupon().then(() => {
            arrayCreateCoupon(couponArray);
        });
        updataAd().then(() => {
            arrayCreateAd(adArray);
        });
    };
    var setCamera = (id, deltaAlpha) => {
        var lon = document.getElementById("lon").value;
        var lat = document.getElementById("lat").value;
        var XY = gcs2Gauss(lon, lat);
        var arPosition = rotationMatrix(XY[0], XY[1], deltaAlpha);
        document.getElementById(id).object3D.position.set(-arPosition[0], 0, arPosition[1]);
    };
    var setRealCoordinate = (id, deltaAlpha) => {
        //這是說明書
        var camera = document.getElementById("camera").object3D.position;
        var lon = document.getElementById("lon").value;
        var lat = document.getElementById("lat").value;
        var XY = gcs2Gauss(lon, lat);
        var arPosition = rotationMatrix(XY[0], XY[1], deltaAlpha);
        document.getElementById(id).object3D.position.set(-arPosition[0] + camera.x, 0, arPosition[1] + camera.z);
    };
    ///////////////////////////////////////////////////////////////////////////////
    var arrayCreateAd =()=>{
        for (var i = 0; i <adArray.length; i++) {
            setadArray(adArray[i].x, adArray[i].y,adArray[i].adid, deltaAlpharam,adArray[i].image);
           
        }
    };
    var  setadArray(x,y,id,deltaAlpha,img_url){
        
        gltf_bin = "https://simondagg.github.io/webar/gltf_test/simple/scene.bin";
        gltf_json = '{"accessors":[{"bufferView":2,"componentType":5126,"count":4,"max":[21.761878967285156,-0.35592755675315857,12.591880798339844],"min":[9.9999980926513672,-0.35592794418334961,3.7575817108154297],"type":"VEC3"},{"bufferView":2,"byteOffset":48,"componentType":5126,"count":4,"max":[0,-1,-4.3855227005451525e-08],"min":[0,-1,-4.3855227005451525e-08],"type":"VEC3"},{"bufferView":3,"componentType":5126,"count":4,"max":[1,0,0,1],"min":[1,0,0,1],"type":"VEC4"},{"bufferView":3,"byteOffset":64,"componentType":5126,"count":4,"max":[1,1,1,1],"min":[1,1,1,1],"type":"VEC4"},{"bufferView":1,"componentType":5126,"count":4,"max":[1,1],"min":[0,0],"type":"VEC2"},{"bufferView":0,"componentType":5125,"count":6,"max":[3],"min":[0],"type":"SCALAR"},{"bufferView":2,"byteOffset":96,"componentType":5126,"count":4,"max":[21.76936149597168,-1.6421401483057707e-07,12.593308448791504],"min":[9.9873237609863281,-5.5047098612703849e-07,3.756779670715332],"type":"VEC3"},{"bufferView":2,"byteOffset":144,"componentType":5126,"count":4,"max":[0,-1,-4.3711391839451608e-08],"min":[0,-1,-4.3711391839451608e-08],"type":"VEC3"},{"bufferView":3,"byteOffset":128,"componentType":5126,"count":4,"max":[1,0,0,1],"min":[1,0,0,1],"type":"VEC4"},{"bufferView":3,"byteOffset":192,"componentType":5126,"count":4,"max":[1,1,1,1],"min":[1,1,1,1],"type":"VEC4"},{"bufferView":0,"byteOffset":24,"componentType":5125,"count":6,"max":[3],"min":[0],"type":"SCALAR"},{"bufferView":2,"byteOffset":192,"componentType":5126,"count":90,"max":[22.171236038208008,-1.5039951506423677e-07,12.913398742675781],"min":[9.6864051818847656,-0.72304564714431763,-1.3346500396728516],"type":"VEC3"},{"bufferView":2,"byteOffset":1272,"componentType":5126,"count":90,"max":[1,1,1],"min":[-1,-1,-1],"type":"VEC3"},{"bufferView":3,"byteOffset":256,"componentType":5126,"count":90,"max":[1,1,1,1],"min":[-1,-1,-1,1],"type":"VEC4"},{"bufferView":3,"byteOffset":1696,"componentType":5126,"count":90,"max":[1,1,1,1],"min":[1,1,1,1],"type":"VEC4"},{"bufferView":0,"byteOffset":48,"componentType":5125,"count":126,"max":[89],"min":[0],"type":"SCALAR"}],"asset":{"extras":{"author":"daviddickball(https://sketchfab.com/daviddickball)","license":"CC-BY-4.0(http://creativecommons.org/licenses/by/4.0/)","source":"https://sketchfab.com/models/7d0d36fbf16e4cc2b62970c49dac3c31","title":"SimpleLow-polyBillboard(4:3)"},"generator":"Sketchfab-3.29.3","version":"2.0"},"bufferViews":[{"buffer":0,"byteLength":552,"byteOffset":0,"name":"floatBufferViews","target":34963},{"buffer":0,"byteLength":32,"byteOffset":552,"byteStride":8,"name":"floatBufferViews","target":34962},{"buffer":0,"byteLength":2352,"byteOffset":584,"byteStride":12,"name":"floatBufferViews","target":34962},{"buffer":0,"byteLength":3136,"byteOffset":2936,"byteStride":16,"name":"floatBufferViews","target":34962}],"buffers":[{"byteLength":6072,"uri":"' + gltf_bin + '"}],"images":[{"uri":"' + img_url + '"}],"materials":[{"doubleSided":true,"emissiveFactor":[0,0,0],"name":"material_0","pbrMetallicRoughness":{"baseColorFactor":[0.5,0.5,0.5,1],"metallicFactor":0,"roughnessFactor":0.59999999999999998}},{"doubleSided":true,"emissiveFactor":[0,0,0],"name":"02_-_Default","pbrMetallicRoughness":{"baseColorFactor":[0.92156899999999997,0.92156899999999997,0.92156899999999997,1],"metallicFactor":0,"roughnessFactor":0.59999999999999998}},{"doubleSided":true,"emissiveFactor":[0,0,0],"name":"material","pbrMetallicRoughness":{"baseColorFactor":[1,1,1,1],"baseColorTexture":{"index":0,"texCoord":0},"metallicFactor":0,"roughnessFactor":0.59999999999999998}}],"meshes":[{"primitives":[{"attributes":{"COLOR_0":3,"NORMAL":1,"POSITION":0,"TANGENT":2,"TEXCOORD_0":4},"indices":5,"material":2,"mode":4}]},{"primitives":[{"attributes":{"COLOR_0":9,"NORMAL":7,"POSITION":6,"TANGENT":8},"indices":10,"material":0,"mode":4}]},{"primitives":[{"attributes":{"COLOR_0":14,"NORMAL":12,"POSITION":11,"TANGENT":13},"indices":15,"material":1,"mode":4}]}],"nodes":[{"children":[1],"name":"RootNode(gltforientationmatrix)","rotation":[-0.70710678118654746,-0,-0,0.70710678118654757]},{"children":[2],"name":"RootNode(modelcorrectionmatrix)"},{"children":[3,6,9],"name":"simplebillboard43.3DS"},{"children":[4],"matrix":[1,0,0,0,0,0,1,0,0,-1,0,0,16.009878158569336,-3.4020638395304559e-07,7.7830142974853516,1],"name":"Object01"},{"children":[5],"matrix":[1,0,0,0,0,-4.3711388286737843e-08,-0.999999999999998,0,0,0.999999999999998,-4.3711388286737843e-08,0,-16.009878158569336,-7.7830142974853507,-2.3954430561530515e-14,1],"name":"3DSMeshMatrix"},{"mesh":0,"name":""},{"children":[7],"matrix":[0.29455095529556274,0,0,0,0,0,0.29455095529556274,0,0,-0.29455095529556274,0,0,15.878342628479004,-3.5734248626795306e-07,8.175044059753418,1],"name":"Plane01"},{"children":[8],"matrix":[3.3949983254902869,0,0,0,0,-1.4840009430789193e-07,-3.3949983254902807,0,0,3.3949983254902807,-1.4840009430789193e-07,0,-53.906946635247259,-27.754260893672175,1.6693234459028334e-13,1],"name":"3DSMeshMatrix"},{"mesh":1,"name":""},{"children":[10],"matrix":[1,0,0,0,0,0,1,0,0,-1,0,0,16.009878158569336,-3.4020638395304559e-07,7.7830142974853516,1],"name":"Box01"},{"children":[11],"matrix":[1,0,0,0,0,-4.3711388286737843e-08,-0.999999999999998,0,0,0.999999999999998,-4.3711388286737843e-08,0,-16.009878158569336,-7.7830142974853507,-2.3954430561530515e-14,1],"name":"3DSMeshMatrix"},{"mesh":2,"name":""}],"samplers":[{"magFilter":9729,"minFilter":9987,"wrapS":10497,"wrapT":10497}],"scene":0,"scenes":[{"name":"OSG_Scene","nodes":[0]}],"textures":[{"sampler":0,"source":0}]}';
        gltf_base64 = window.btoa(unescape(encodeURIComponent(gltf_json)));
        var camera = document.getElementById("camera").object3D.position;
        var scene = document.getElementById("scene");
        var assets = document.getElementById("assets");
        var ad = document.createElement("a-asset-item");
        assets.appendChild(ad);
        ad.setAttribute("id", id);
        ad.setAttribute('src', "data:model/gltf+json;;base64, " + gltf_base64);
        var arPosition = rotationMatrix(x, y, deltaAlpha);
        var obj = document.createElement("a-entity");
        scene.appendChild(obj);
        obj.setAttribute("id", id);
        obj.setAttribute("gltf-model", "#"+id);
        couponx.push(-arPosition[0]);
        coupony.push(arPosition[1]);
        document.getElementById(id).object3D.position.set(-arPosition[0], 0, arPosition[1]);
    }

    var updataAd = () => {
        adArray = []
        var i = 0;
        var query = firebase.database().ref("AdObject").orderByKey();
        query.once("value")
            .then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    var key = childSnapshot.key;
                    var childData = childSnapshot.val();
                    adArray.push(childData);
                    adArray[i] = Object.assign(adArray[i], { adid: key });
                    i = i + 1;
                });
            });
        return query.once("value").then();
    };
    var deletAdArray = (dataArray) => {
        for (var i = 0; i < dataArray.length; i++) {
            deletAnyObj(dataArray[i].adid);
        }
    };
//////////////////////////////////////////////////////////////////////////////////////////////////
    var arrayCreateCoupon=()=>{
        for (var i = 0; i <couponArray.length; i++) {
            setCoupon(couponArray[i].x, couponArray[i].y,couponArray[i].couponid, deltaAlpharam);
           
        }
    }
    var setCoupon =(x,y,id,deltaAlpha) =>{
        var camera = document.getElementById("camera").object3D.position;
        var scene = document.getElementById("scene");
        var arPosition = rotationMatrix(x, y, deltaAlpha);
        var obj = document.createElement("a-entity");
        scene.appendChild(obj);
        obj.setAttribute("id", id);
        obj.setAttribute("gltf-model", "#gift");
        couponx.push(-arPosition[0]);
        coupony.push(arPosition[1]);
        document.getElementById(id).object3D.position.set(-arPosition[0], 0, arPosition[1]);
    }
    var updataCoupon = () => {
        couponArray = []
        var i = 0;
        var query = firebase.database().ref("Coupon").orderByKey();
        query.once("value")
            .then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    var key = childSnapshot.key;
                    var childData = childSnapshot.val();
                    couponArray.push(childData);
                    couponArray[i] = Object.assign(couponArray[i], { couponid: key });
                    i = i + 1;
                });
            });
        return query.once("value").then();
    };
       var objCursorEvent = () => {
        for (var i = 0; i < dataArrayy.length; i++) {
            (cursor(datax[i], datay[i])) ? showObjImfo(dataArrayy[i]) : doNothing();
        }
        for (var i = 0; i < couponArray.length; i++) {
            (cursor(couponx[i], coupony[i])) ? showCursorImfo(couponArray[i]) : doNothing();
        }
    }
    var deletCursorArray = (dataArray) => {
        for (var i = 0; i < dataArray.length; i++) {
            deletAnyObj(dataArray[i].couponid);
        }
    };
    var showCursorImfo =(objImfo)=>{
        var addfri = '<div id="addCou"> <div class="ui message"> <i class="close icon" onclick="deletaddCouForm()"></i> <div class="header" style="font-family:微軟正黑體; font-size:150%"> ' + objImfo.title + '  </div> <br>';
        addfri = addfri + '<p>' + objImfo.content + '</p>';
        addfri = addfri + '<div id="AKQAAZSYRAKFPQSY" class="extra content"> <button id="' + objImfo.couponid + '"class="ui basic button like addfriend" onclick="collection(this.id)"> <i class="like icon"></i> 收藏 </button> <button id="' + objImfo.couponid + '"class="ui basic button bullhorn report addfriend" onclick="couponReport(this.id)"> <i class="bullhorn icon"></i> 檢舉 </button> </div> </div> </div>';
        document.getElementById("addCouForm").innerHTML = addfri;
    }
    var deletaddCouForm = () =>{
        var addCouForm = document.getElementById("addCouForm");
        addCouForm.removeChild(document.getElementById("addCou"));
    }
    var collection=(couponid)=>{
        firebase.database().ref('CouponCollection/'+couponid+'/'+userID).set({
        date: firebase.database.ServerValue.TIMESTAMP,
        pay:false
      });
      firebase.database().ref('CouponCollection/'+userID+'/'+couponid).set({
        date: firebase.database.ServerValue.TIMESTAMP,
        pay:false  
      });
    }
    var couponReport=(couponid)=>{
    }
    //////////////////
    var  arrayCreateObj= (dataArray)=> {
        for (var i = 0; i < dataArray.length; i++) {
            setPosition(dataArray[i].x, dataArray[i].y, dataArray[i].objid, dataArray[i].module, deltaAlpharam);
        }
    }
    var deletDataArray = (dataArray) => {
        for (var i = 0; i < dataArray.length; i++) {
            deletAnyObj(dataArray[i].objid);
        }
    };
    var deletAnyObj = (id) => {
        try {
            var scene = document.getElementById("scene");
            scene.removeChild(document.getElementById(id));
        } catch (e) {
            console.log("i dont know what happen");
        }
    };
    let setPosition = (x, y, id, modClass, deltaAlpha) => {//obj
        var camera = document.getElementById("camera").object3D.position;
        var scene = document.getElementById("scene");
        var arPosition = rotationMatrix(x, y, deltaAlpha);//
        var obj = document.createElement("a-entity");
        scene.appendChild(obj);
        obj.setAttribute("id", id);
        var modname = (modClass == 1) ? "#bulbasaur" : (modClass == 2) ? "#geodude" : (modClass == 3) ? "#poliwhirl" : "#bulbasaur";
        var scale = (modClass == 1) ? "1 1 1" : (modClass == 2) ? "0.5 0.5 0.5" : (modClass == 3) ? "0.3 0.3 0.3" : "0.3 0.3 0.3";
        obj.setAttribute("gltf-model", modname);
        obj.setAttribute("scale", scale);
        datax.push(-arPosition[0]);
        datay.push(arPosition[1]);
        document.getElementById(id).object3D.position.set(-arPosition[0], 0, arPosition[1]);
    };
 
    var showObjImfo = (objImfo) => {
        var addfri = '<div id="add_fri"> <div class="ui message"> <i class="close icon" onclick="deletAddFriForm()"></i> <div class="header" style="font-family:微軟正黑體; font-size:150%"> '+objImfo.name+'  </div> ';
        addfri = addfri + '<p>' + objImfo.title + '</p><br>' + '<p>' + objImfo.content + '</p>';
        addfri = addfri + '<div id="AKQAAZSYRAKFPQSY" class="extra content"> <button id="' + objImfo.user + '"class="ui basic button like addfriend" onclick="object_addfriend(this.id)"> <i class="like icon"></i> 加好友 </button> <button id="' + objImfo.objid + '"class="ui basic button bullhorn report addfriend" onclick="object_report(this.id)"> <i class="bullhorn icon"></i> 檢舉 </button> </div> </div> </div>';
        document.getElementById("addFriForm").innerHTML = addfri;
    };
    var deletAddFriForm = () => {
        var addFriForm = document.getElementById("addFriForm");
        addFriForm.removeChild(document.getElementById("add_fri"));
    };
   
    var updataObj = () => {
        dataArrayy = []
        var i = 0;
        var query = firebase.database().ref("Object").orderByKey();
        query.once("value")
            .then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    var key = childSnapshot.key;
                    var childData = childSnapshot.val();
                    dataArrayy.push(childData);
                    dataArrayy[i] = Object.assign(dataArrayy[i], { objid: key });
                    i = i + 1;
                });
            });
        return query.once("value").then();
    };
  
    
    setTimeout(_init_(), 10000);
</script>
